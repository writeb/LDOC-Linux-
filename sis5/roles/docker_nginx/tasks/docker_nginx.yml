---
- name: Install Docker (frontend)
  apt:
    name:
      - docker.io
    state: present
    update_cache: yes

- name: Ensure docker service is running
  service:
    name: docker
    state: started
    enabled: yes

- name: Install custom-nginx systemd unit
  copy:
    dest: /etc/systemd/system/custom-nginx.service
    mode: '0644'
    content: |
      [Unit]
      Description=Custom Nginx Docker Container
      After=network.target docker.service
      Requires=docker.service

      [Service]
      ExecStartPre=-/usr/bin/docker stop custom-nginx
      ExecStartPre=-/usr/bin/docker rm custom-nginx
      ExecStartPre=/usr/bin/docker pull writeb432/custom-nginx:1.0
      ExecStart=/usr/bin/docker run --name custom-nginx -p 80:80 writeb432/custom-nginx:1.0
      ExecStop=/usr/bin/docker stop custom-nginx
      Restart=always
      RestartSec=5

      [Install]
      WantedBy=multi-user.target

- name: Reload systemd
  systemd:
    daemon_reload: true

- name: Enable and start custom-nginx
  systemd:
    name: custom-nginx
    state: started
    enabled: yes
